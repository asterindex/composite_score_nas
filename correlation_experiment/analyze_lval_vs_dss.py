#!/usr/bin/env python3
"""
–ê–Ω–∞–ª—ñ–∑: —á–∏ –ø—Ä–æ—Å—Ç–∞ L_val –∫—Ä–∞—â–∞ –∑–∞ DSS –¥–ª—è —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è?
"""

import numpy as np
from scipy.stats import spearmanr

# –î–∞–Ω—ñ –∑ –ª–æ–≥—É (DSS values —Ç–∞ final losses –¥–ª—è –≤—Å—ñ—Ö 50 trials)
# DSS values (–∑ –ª–æ–≥—É —Å–∏–Ω—Ç–µ–∑—É)
dss_values = {
    0: -0.8457, 1: -1.8540, 2: -1.3269, 3: -2.1910, 4: -0.5692,
    5: -2.3040, 6: -0.8481, 7: -2.2434, 8: -1.6154, 9: -1.9210,
    10: -2.8300, 11: -2.1129, 12: -2.4866, 13: -2.0826, 14: -1.9024,
    15: -1.5566, 16: -2.0522, 17: -2.4542, 18: -1.6812, 19: -2.0874,
    20: -0.9789, 21: -1.6915, 22: -2.9911, 23: -1.3214, 24: -2.0268,
    25: -1.5300, 26: -1.7421, 27: -1.4981, 28: -1.3930, 29: -2.1938,
    30: -1.4412, 31: -1.8567, 32: -2.0546, 33: -1.5690, 34: -1.7718,
    35: -1.7263, 36: -1.8080, 37: -1.9754, 38: -2.5472, 39: -2.0537,
    40: -2.0600, 41: -2.4231, 42: -1.7521, 43: -1.6721, 44: -2.9801,
    45: -0.6956, 46: -2.5760, 47: -2.1697, 48: -2.2018, 49: -1.2372
}

# Final losses (–∑ –ª–æ–≥—É full training)
final_losses = {
    0: 1.1008, 1: 1.0765, 2: 1.0879, 3: 1.0964, 4: 1.0976,
    5: 1.0693, 6: 1.0979, 7: 1.0750, 8: 1.0968, 9: 1.0814,
    10: 1.0832, 11: 1.0773, 12: 1.0807, 13: 1.0751, 14: 1.0767,
    15: 1.0809, 16: 1.0924, 17: 1.0760, 18: 1.0660, 19: 1.0772,
    20: 1.1260, 21: 1.0800, 22: 1.0831, 23: 1.0736, 24: 1.0831,
    25: 1.0686, 26: 1.0839, 27: 1.0830, 28: 1.0876, 29: 1.0714,
    30: 1.0914, 31: 1.0777, 32: 1.0777, 33: 1.0838, 34: 1.0781,
    35: 1.0726, 36: 1.0783, 37: 1.0664, 38: 1.0817, 39: 1.0678,
    40: 1.0848, 41: 1.0759, 42: 1.0830, 43: 1.0734, 44: 1.0823,
    45: 1.1137, 46: 1.0848, 47: 1.0877, 48: 1.0860, 49: 1.0886
}

# –¢—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏ L_val –ø—ñ—Å–ª—è 2 –µ–ø–æ—Ö
# –ó —Ñ–æ—Ä–º—É–ª–∏ DSS: DSS = z(L_val) + 0.6*z(gap) + 0.4*z(loss_cv) + 0.2*z(grad_cv) - 0.4*z(impr)
# –ê–ª–µ L_val –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ª–æ–≥—É —è–≤–Ω–æ...

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—è: –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑ DSS
# –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –æ—Å–Ω–æ–≤–Ω–∏–π –≤–Ω–µ—Å–æ–∫ –≤ DSS ‚Äî —Ü–µ L_val (z-normalized)
# –¢–æ–¥—ñ: DSS ‚âà z(L_val) + noise
# –ê–±–æ –ø—Ä–æ—Å—Ç—ñ—à–µ: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ val_loss –∑ –∫—ñ–Ω—Ü—è 2-epoch —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è

# –ó –ª–æ–≥—É —Å–∏–Ω—Ç–µ–∑—É –±–∞—á–∏–º–æ "Best value" ‚Äî —Ü–µ DSS –¥–ª—è warmup –∞–±–æ DSS –ø—ñ—Å–ª—è
# –ê–ª–µ –¥–ª—è –ø–µ—Ä—à–∏—Ö 10 trials (warmup): objective = L_val + 0.5*gap

# –ü–†–û–ë–õ–ï–ú–ê: –≤ –ª–æ–≥—É –Ω–µ–º–∞—î —è–≤–Ω–∏—Ö L_val –ø—ñ—Å–ª—è 2 –µ–ø–æ—Ö!
# –ü–æ—Ç—Ä—ñ–±–Ω–æ –∞–±–æ:
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º L_val
# 2. –û—Ü—ñ–Ω–∏—Ç–∏ L_val –∑ DSS (–Ω–µ—Ç–æ—á–Ω–æ)
# 3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ

print("=" * 70)
print("–ê–ù–ê–õ–Ü–ó: L_val vs DSS –¥–ª—è —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è")
print("=" * 70)
print()

# –ü—ñ–¥—Ö—ñ–¥: –æ—Ü—ñ–Ω–∏—Ç–∏ L_val –∑ DSS
# –Ø–∫—â–æ DSS = z(L_val) + —ñ–Ω—à—ñ —Ç–µ—Ä–º–∏, —ñ –≤–∞–≥–∏ –¥–æ—Å–∏—Ç—å –≤–µ–ª–∏–∫—ñ –Ω–∞ L_val,
# —Ç–æ —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è –ø–æ DSS ‚âà —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è –ø–æ L_val –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º —à—É–º–æ–º

# –î–ª—è —Å–∏–º—É–ª—è—Ü—ñ—ó: —Å—Ç–≤–æ—Ä–∏–º–æ "estimated L_val" = denormalize(DSS component)
# –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ median L_val ‚âà 1.5, IQR ‚âà 0.3 (–∑ –¥–æ—Å–≤—ñ–¥—É)

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ L_val –≤ —Ä–æ–∑—É–º–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
# –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –∑ final loss

np.random.seed(42)

# –°–∏–º—É–ª—é—î–º–æ L_val –ø—ñ—Å–ª—è 2 –µ–ø–æ—Ö
# –†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–æ: L_val –ø—ñ—Å–ª—è 2 –µ–ø–æ—Ö –º–∞—î —Å–ª–∞–±–∫—É –∫–æ—Ä–µ–ª—è—Ü—ñ—é –∑ final (0.3-0.5)
# –î–æ–¥–∞–º–æ —à—É–º –¥–æ final losses

trials = list(range(50))
final = np.array([final_losses[i] for i in trials])
dss = np.array([dss_values[i] for i in trials])

# –°–∏–º—É–ª—è—Ü—ñ—è L_val: –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ final + –±—ñ–ª—å—à–∏–π —à—É–º (—Ä–∞–Ω–Ω—î —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è)
# L_val_2epoch ‚âà final_loss * scale + noise
scale = 1.3  # –ü—ñ—Å–ª—è 2 –µ–ø–æ—Ö losses –≤–∏—â—ñ
noise_std = 0.15  # –ë—ñ–ª—å—à–∏–π —à—É–º –Ω–∞ —Ä–∞–Ω–Ω—ñ—Ö –µ–ø–æ—Ö–∞—Ö

estimated_lval = final * scale + np.random.normal(0, noise_std, size=50)

print("‚ö†Ô∏è  –í–ê–ñ–õ–ò–í–û: L_val –ø—ñ—Å–ª—è 2 –µ–ø–æ—Ö –ù–ï –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ª–æ–≥–∞—Ö!")
print("   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é –°–ò–ú–£–õ–¨–û–í–ê–ù–Ü –¥–∞–Ω—ñ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –º–µ—Ç–æ–¥—É")
print()

# –†–∞–Ω–∂—É–≤–∞–Ω–Ω—è
dss_ranks = np.argsort(np.argsort(dss))  # Lower DSS = better rank
lval_ranks = np.argsort(np.argsort(estimated_lval))  # Lower L_val = better rank  
final_ranks = np.argsort(np.argsort(final))  # Lower loss = better rank

# –ö–æ—Ä–µ–ª—è—Ü—ñ—ó
rho_dss, p_dss = spearmanr(dss, final)
rho_lval, p_lval = spearmanr(estimated_lval, final)

print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢–ò –ö–û–†–ï–õ–Ø–¶–Ü–á (—Å–∏–º—É–ª—è—Ü—ñ—è):")
print(f"   DSS       ‚Üî Final:  œÅ = {rho_dss:.4f}, p = {p_dss:.4f}")
print(f"   L_val     ‚Üî Final:  œÅ = {rho_lval:.4f}, p = {p_lval:.4f}")
print()

# Rank stability
dss_stability = (dss_ranks == final_ranks).sum() / len(trials) * 100
lval_stability = (lval_ranks == final_ranks).sum() / len(trials) * 100

print(f"üéØ RANK STABILITY:")
print(f"   DSS:   {dss_stability:.1f}%")
print(f"   L_val: {lval_stability:.1f}%")
print()

# Top-10 accuracy
top10_final = set(np.argsort(final)[:10])
top10_dss = set(np.argsort(dss)[:10])
top10_lval = set(np.argsort(estimated_lval)[:10])

overlap_dss = len(top10_dss & top10_final)
overlap_lval = len(top10_lval & top10_final)

print(f"‚úÖ TOP-10 OVERLAP:")
print(f"   DSS:   {overlap_dss}/10 –º–æ–¥–µ–ª–µ–π")
print(f"   L_val: {overlap_lval}/10 –º–æ–¥–µ–ª–µ–π")
print()

print("=" * 70)
print("–í–ò–°–ù–û–í–û–ö (–ù–ê –û–°–ù–û–í–Ü –°–ò–ú–£–õ–Ø–¶–Ü–á):")
print("=" * 70)
print()
print("–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¢–û–ß–ù–Ü —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, –ø–æ—Ç—Ä—ñ–±–Ω–æ:")
print()
print("1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–æ–¥ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º L_val:")
print("   trial.set_user_attr('L_val_2epoch', val_loss)")
print()
print("2. –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ:")
print("   - trials_proxy_metrics.csv")
print("   - synthesis_results.json")
print()
print("3. –¢–æ–¥—ñ –º–æ–∂–Ω–∞ —Ç–æ—á–Ω–æ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏:")
print("   - –ü—Ä–æ—Å—Ç–∞ L_val (validation loss)")
print("   - DSS (–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è 5 –º–µ—Ç—Ä–∏–∫)")
print("   - Final loss (–ø—ñ—Å–ª—è 15 –µ–ø–æ—Ö)")
print()
print("=" * 70)
